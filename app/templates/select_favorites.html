{% extends "base.html" %}

{% block content %}
<div class="animate-fade duration-500 delay-200 transition-colors">
<div>
<h2 class="text-4xl font-extrabold dark:text-white text-black text-center transition-colors duration-500 delay-200">Select 5 or more favorites!</h2>
<p class="text-2xl font-extrabold dark:text-white text-black text-center transition-colors duration-500 delay-200" id="length">{{ selected|length }} Selected</p>
<hr class="w-48 h-1 mx-auto my-4 bg-gray-300 border-0 rounded-sm md:my-10 dark:bg-gray-700 transition-colors duration-500 delay-200">
</div>


<form method="post" action="{{ url_for('main.select_favorites') }}">
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 p-4 animate-fade duration-1000 delay-200">
  {% for game in games %}
    {% include 'game_card.html' %}
  {% endfor %}
</div>

<input type="hidden" name="offset" value="{{ offset or 0 }}">

<div class="flex justify-between mt-4">
  {% if previous_offset is not none %}
    <a href="?offset={{ previous_offset }}{% if current_platform %}&platform={{ current_platform }}{% endif %}{% if current_genre and current_genre != 'all' %}&genre={{ current_genre }}{% endif %}" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded text-black">
      ← Previous Page
    </a>
  {% else %}
    <span></span>
  {% endif %}
  
  {% if next_offset is not none %}
    <a href="?offset={{ next_offset }}{% if current_platform %}&platform={{ current_platform }}{% endif %}{% if current_genre and current_genre != 'all' %}&genre={{ current_genre }}{% endif %}" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
      Next Page →
    </a>
  {% endif %}
</div>
  
<input
  id="continue-btn"
  type="submit"
  value="Go!"
  name="continue"
  class="cursor-pointer border-2 fixed bottom-24 left-1/2 transform w-24 h-24 z-50 bg-green-600 hover:bg-green-700 border-green-500 hover:border-green-800 hover:scale-125 rounded-full text-white font-bold shadow-lg text-2xl transition-all duration-300 ease-in-out"
  onclick="document.getElementById('spinnerOverlay').style.display = 'flex'"
>
</form>
</div>
{% include "spinner.html" %}
{% endblock %}

{% block scripts %}
<script>
// Check for platform selection from previous page
document.addEventListener('DOMContentLoaded', function() {
    const selectedPlatform = sessionStorage.getItem('selectedPlatform');
    const urlParams = new URLSearchParams(window.location.search);
    const currentPlatform = urlParams.get('platform');

    if (selectedPlatform && selectedPlatform !== 'all') {
        // If no platform in URL or different platform, update it
        if (!currentPlatform || currentPlatform !== selectedPlatform) {
            urlParams.set('platform', selectedPlatform);
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState({}, '', newUrl);
            window.location.reload();
        }
    }
});

const container = document.querySelector('.grid');
const continueBtn = document.getElementById("continue-btn")
const lengthDisplay = document.getElementById('length')

let localCount = 0;

// Initialize checkboxes and count based on sessionStorage
function initializeCheckboxes() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const currentPageSelected = sessionStorage.getItem('currentPageSelected') || '{}';
    const currentPageSelectedObj = JSON.parse(currentPageSelected);

    localCount = 0;

    checkboxes.forEach(checkbox => {
        const gameId = checkbox.value;
        const wasLocalSelected = currentPageSelectedObj[gameId];

        if (currentPageSelectedObj[gameId]) {
            checkbox.checked = true;
            localCount++;
        }
        // Keep server-side selection if no local override
    });

    updateDisplay();
}

function updateDisplay() {
    const serverCount = Number("{{ selected|length }}");
    const currentCount = localCount + serverCount;

    lengthDisplay.textContent = currentCount + " Selected";

    if (continueBtn) {
        if (currentCount >= 5) {
            continueBtn.classList.remove('hidden');
        } else {
            continueBtn.classList.add('hidden');
        }
    }
}

// Save current page checkbox states to sessionStorage
function saveCurrentPageState() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const currentPageSelected = {};

    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            currentPageSelected[checkbox.value] = true;
        }
    });

    sessionStorage.setItem('currentPageSelected', JSON.stringify(currentPageSelected));
}

// Initialize on page load
initializeCheckboxes();

container.addEventListener('mouseenter', event => {
  const card = event.target.closest('.group');
  if (!card) return;
  const video = card.querySelector('video');
  if (video) video.play();
}, true); // Use capture phase to catch mouseenter properly

container.addEventListener('mouseleave', event => {
  const card = event.target.closest('.group');
  if (!card) return;
  const video = card.querySelector('video');
  if (video) video.pause();
}, true);

// Save state before navigation
document.addEventListener('beforeunload', saveCurrentPageState);

function updateItemStatus(element) {
    const isCheckbox = element.type === 'checkbox';

    if (isCheckbox) {
        const isChecked = element.checked;

        if (isChecked) {
            localCount += 1;
        } else {
            localCount -= 1;
        }

        // Update sessionStorage immediately
        saveCurrentPageState();
    }

    updateDisplay();

    if (isCheckbox) {
        const formData = new FormData();
        formData.append('selected_games', element.value);
        formData.append('checked', element.checked);

        fetch('/update-game-selection', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the display with the server count
                lengthDisplay.textContent = data.total_count + " Selected";

                // Update continue button visibility
                if (continueBtn) {
                    if (data.total_count >= 5) {
                        continueBtn.classList.remove('hidden');
                    } else {
                        continueBtn.classList.add('hidden');
                    }
                }
            } else {
                console.error('Update failed:', data.message);
            }
        })
        .catch(error => {
            console.error('Error updating game selection:', error);
        });
    }
}
</script>
{% endblock %}